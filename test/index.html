<!DOCTYPE html>
<html>
<div id = "cpu"></div>
<body>

</body>
<script>
    var dataArray = [];

    var date = new Date();
    var timezone = "+00:00";
    var isoTime = date.toISOString().replace('Z', timezone);

    var cpuQuery = 'from(bucket: "control") \
    |> range(start: -1m) \
    |> filter(fn: (r) => r["_measurement"] == "cpu") \
    |> filter(fn: (r) => r["_field"] == "usage_system" or r["_field"] == "usage_user") \
    |> filter(fn: (r) => r["cpu"] == "cpu-total") \
    |> last()';

    var diskQuery = 'from(bucket: "control") \
    |> range(start: -1m) \
    |> filter(fn: (r) => r["_measurement"] == "disk") \
    |> filter(fn: (r) => r["_field"] == "used_percent" or r["_field"] == "used") \
    |> last()';

    var memoryQuery = 'from(bucket: "control") \
    |> range(start: -1m) \
    |> filter(fn: (r) => r["_measurement"] == "mem") \
    |> filter(fn: (r) => r["_field"] == "used" or r["_field"] == "used_percent" or r["_field"] == "total") \
    |> last()';


    var networkQuery = 'from(bucket: "control") \
    |> range(start: -1m) \
    |> filter(fn: (r) => r["_measurement"] == "net") \
    |> filter(fn: (r) => r["_field"] == "bytes_recv" or r["_field"] == "bytes_sent") \
    |> last()';

    var queryData =
    {
        "dialect": {
            "annotations": [
                "group"
            ],
            "commentPrefix": "#",
            "dateTimeFormat": "RFC3339",
            "delimiter": ",",
            "header": true
        },
        "now": isoTime,
        "params": {},
        "query": cpuQuery,
        "type": "flux"
    };

    setInterval(function () {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {

                // var jsonValue = JSON.parse(this.responseText);
                console.log(this.responseText);
                dataArray = this.responseText.split(",");
                console.log(dataArray);
                var cpuTotalPercent = parseFloat(dataArray[26]) + parseFloat(dataArray[36]);
                console.log(cpuTotalPercent);
                document.getElementById('cpu').innerText = cpuTotalPercent.toFixed(1);
            }
        };

        xhttp.open('POST', 'http://192.168.60.123:8086/api/v2/query?org=raon', true);

        xhttp.setRequestHeader('Content-Type', 'application/json');
        xhttp.setRequestHeader("Authorization", "Token 6dXJhSSVJ-uQWlZ9qhsza_jW52IS5qe7s_BIxQqAw99FuqWOeR5lPJ4mjnIfgMxLfLGVVq69uH6_KU1EHzKsWw==") // RAON
        // xhttp.setRequestHeader("Authorization", "Token 6UyxcltMVociLrcCamGD1XzbfoQ5OSV4xjIU2waBfLM7fkfj6kRN0lNWIfgGl7PhXU5TfY33RvjgS0LaCWdfog==") // HOME
        xhttp.send(JSON.stringify(queryData));
        // xhttp.send(createBucket);
        date = new Date();
        isoTime = date.toISOString().replace('Z', timezone);
        queryData.now = isoTime;
        console.log(isoTime);
    }, 5000);

</script>

</html>